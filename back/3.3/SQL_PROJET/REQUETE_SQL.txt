-- Étudiants BUT2 prêts à la remontée
SELECT e.IdEtudiant, e.nom, e.prenom,
       s.Statut AS statut_stage,
       p.Statut AS statut_portfolio
FROM EtudiantsBUT2ou3 e
JOIN EvalStage s ON e.IdEtudiant = s.IdEtudiant
JOIN EvalPortfolio p ON e.IdEtudiant = p.IdEtudiant
JOIN AnneeStage ast ON e.IdEtudiant = ast.IdEtudiant
WHERE ast.but3sinon2 = FALSE   -- BUT2
  AND s.Statut = 'BLOQUEE'
  AND p.Statut = 'BLOQUEE';

-- Étudiants BUT3 prêts à la remontée
SELECT e.IdEtudiant, e.nom, e.prenom,
       s.Statut AS statut_stage,
       p.Statut AS statut_portfolio,
       a.Statut AS statut_anglais
FROM EtudiantsBUT2ou3 e
JOIN EvalStage s ON e.IdEtudiant = s.IdEtudiant
JOIN EvalPortfolio p ON e.IdEtudiant = p.IdEtudiant
JOIN EvalAnglais a ON e.IdEtudiant = a.IdEtudiant
JOIN AnneeStage ast ON e.IdEtudiant = ast.IdEtudiant
WHERE ast.but3sinon2 = TRUE   -- BUT3
  AND s.Statut = 'BLOQUEE'
  AND p.Statut = 'BLOQUEE'
  AND a.Statut = 'BLOQUEE';


-- Étudiants en retard (tous BUT2 ou BUT3)
SELECT e.IdEtudiant, e.nom, e.prenom,
       s.Statut AS statut_stage,
       p.Statut AS statut_portfolio,
       COALESCE(a.Statut, 'NON CONCERNE') AS statut_anglais,
       s.date_h AS date_soutenance
FROM EtudiantsBUT2ou3 e
JOIN EvalStage s ON e.IdEtudiant = s.IdEtudiant
JOIN EvalPortfolio p ON e.IdEtudiant = p.IdEtudiant
LEFT JOIN EvalAnglais a ON e.IdEtudiant = a.IdEtudiant
JOIN AnneeStage ast ON e.IdEtudiant = ast.IdEtudiant
WHERE s.date_h < NOW()
  AND (
        s.Statut = 'SAISIE'
     OR p.Statut = 'SAISIE'
     OR (ast.but3sinon2 = TRUE AND a.Statut = 'SAISIE')
  );





